# Development Session - 2025-12-11

## Features Implemented

### 1. Email Verification Flow

**Endpoints:**
- `POST /api/v1/auth/verify-email` - Verify email with token (public)
- `POST /api/v1/auth/resend-verification` - Resend verification email (authenticated)

**Components:**
- `email_verified` and `email_verified_at` fields on User model
- `EmailVerificationToken` model in `app/blueprints/auth/models.py`
- `email_verification_tokens` database table
- `send_verification_email_task` Celery task
- `cleanup_expired_email_verification_tokens` Celery task
- `VerifyEmailSchema` for request validation

**Behavior:**
- Registration automatically sends verification email
- Tokens expire after 24 hours
- Tokens are single-use
- Resending invalidates previous tokens
- Invited users are auto-verified (they received the invite email)

**Tests:** 12 new tests in `tests/test_auth.py`

---

### 2. User Invitation Flow

**Endpoints:**
- `POST /api/v1/users/invite` - Invite user to tenant (requires USERS_CREATE permission)
- `POST /api/v1/auth/accept-invite` - Accept invitation and join tenant (public)

**Components:**
- `UserInvitation` model in `app/blueprints/auth/models.py`
- `user_invitations` database table
- `send_invitation_email_task` Celery task
- `cleanup_expired_invitations` Celery task
- `InviteUserSchema`, `InvitationResponseSchema` in users schemas
- `AcceptInviteSchema` in auth schemas

**Behavior:**
- Owner/Admin invites user by email
- Optional role assignment on invitation
- Tokens expire after 7 days
- Accepting creates user (or adds existing user to tenant)
- Invited users are auto-verified
- New invitation invalidates previous pending invitations

**Tests:** 12 new tests in `tests/test_auth.py`

---

### 3. Multi-Tenant User Support

**Endpoints:**
- `GET /api/v1/users/me/tenants` - List all tenants user belongs to (authenticated)
- `POST /api/v1/auth/switch-tenant` - Switch to a different tenant (authenticated)

**Components:**
- `list_user_tenants()` in UserService
- `switch_tenant()` in AuthService
- `SwitchTenantSchema` in auth schemas
- `UserTenantResponseSchema`, `UserTenantListResponseSchema` in users schemas

**Behavior:**
- Users can see all tenants they belong to
- Response includes `is_current` flag for active tenant
- Switching generates new token pair for target tenant
- Validates user is a member of target tenant
- Rejects switching to suspended/canceled tenants

**Tests:** 11 new tests in `tests/test_auth.py`

---

## Database Migrations

1. `2e3470e7daa7_add_email_verification_fields_and_table.py`
   - Added `email_verified` (boolean) to users
   - Added `email_verified_at` (datetime) to users
   - Created `email_verification_tokens` table

2. `15d12dabd912_add_user_invitations_table.py`
   - Created `user_invitations` table

---

## Test Summary

| Before | After | New Tests |
|--------|-------|-----------|
| 163    | 174   | +11 (multi-tenant user support) |
| 151    | 163   | +12 (invitation) |
| 139    | 151   | +12 (email verification) |

**Total: 174 tests passing**

---

## Files Changed

### New/Modified Models
- `app/blueprints/users/models.py` - Added email verification fields
- `app/blueprints/auth/models.py` - Added EmailVerificationToken, UserInvitation

### Services
- `app/blueprints/auth/services.py` - Added verify_email, resend_verification, accept_invite, switch_tenant
- `app/blueprints/users/services.py` - Added invite_user, list_user_tenants

### Routes
- `app/blueprints/auth/routes.py` - Added verify-email, resend-verification, accept-invite, switch-tenant
- `app/blueprints/users/routes.py` - Added invite, me/tenants

### Schemas
- `app/blueprints/auth/schemas.py` - Added VerifyEmailSchema, AcceptInviteSchema, SwitchTenantSchema
- `app/blueprints/users/schemas.py` - Added InviteUserSchema, InvitationResponseSchema, UserTenantResponseSchema, UserTenantListResponseSchema

### Tasks
- `app/core/tasks.py` - Added email verification and invitation tasks

### Middleware
- `app/core/middleware.py` - Added verify-email and accept-invite to exempt paths

---

## API Endpoints (Current Total: 42)

**Auth (12):** login, register, refresh, bootstrap, logout, logout-all, forgot-password, reset-password, verify-email, resend-verification, accept-invite, switch-tenant

**Users (9):** me (GET/PUT), list, get, create, update, delete, invite, me/tenants

**Tenants (2):** current (GET/PUT)

**Stores (8):** list, get, create, update, delete, users (GET/POST/DELETE)

**RBAC (9):** roles CRUD, permissions list, user roles (GET/POST/DELETE)

**Health (2):** health, health/db
